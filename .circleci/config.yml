version: 2
jobs:
  build-gimp-2-10:
    macos:
        xcode: "10.0.0"
      
    steps:
        - checkout
        - run:
            name: Cleanup /usr/local
            command: sudo rm -rf /usr/local/*
        - run:
            name: Setup rust
            command: curl https://sh.rustup.rs -sSf | sh -s -- -y                        
        - run:
            name: Setup jhbuild
            command: | 
              curl  https://gitlab.gnome.org/samm-git/gtk-osx/raw/fork-test/gtk-osx-build-setup.sh | sh
              echo 'export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"' > ~/.profile
              echo 'export ARCHFLAGS="-arch x86_64"' >> ~/.profile
              cat ~/.profile
        - run:
            name: Setup gtk-mac-bundler
            command: | 
              cd ~/Source
              git clone https://github.com/samm-git/gtk-mac-bundler -b fix-otool
              cd gtk-mac-bundler
              make install
        # we need to make it automatically depended on the corresponding modules
        - restore_cache:
            keys: 
              - gimp-2.10.8-v5
              - webkit-v8
              - gimp-deps-v8
              - bootstrap-v12
        - run:
            name: Setup 10.9 SDK
            command: | 
              cd /Library/Developer/CommandLineTools/SDKs
              sudo curl -L 'https://github.com/phracker/MacOSX-SDKs/releases/download/MacOSX10.11.sdk/MacOSX10.9.sdk.tar.xz' | sudo tar -xzf - 
              echo 'export SDKROOT=/Library/Developer/CommandLineTools/SDKs/MacOSX10.9.sdk' >> ~/.profile
        - run:
            name: Bootstrap
            command: source ~/.profile && jhbuild bootstrap && jhbuild build python python-six meta-gtk-osx-freetype meta-gtk-osx-bootstrap meta-gtk-osx-core
        - run:
            name: Cleanup
            command: find  ~/gtk/source -type d -mindepth 1 -maxdepth 1 | xargs -I% rm -rf %/*
        - save_cache:
            paths:
              - ~/gtk
            key: bootstrap-v12
        - run:
            name: Build all GIMP dependencies
            command: source ~/.profile && jhbuild build $(jhbuild info gimp|grep '^Requires:'|sed 's|^Requires:||'|tr -d ',')
        - run:
            name: Build all WebKit dependencies
            command: source ~/.profile && jhbuild build $(jhbuild info webkit|grep '^Requires:'|sed 's|^Requires:||'|tr -d ',')
        - run:
            name: Cleanup
            command: find  ~/gtk/source -type d -mindepth 1 -maxdepth 1 | xargs -I% rm -rf %/*
        - save_cache:
            paths:
              - ~/gtk
            key: gimp-deps-v8
        - run:
            name: Build WebKit v1
            no_output_timeout: 1h
            command: source ~/.profile && jhbuild build webkit
        - run:
            name: Cleanup
            command: find  ~/gtk/source -type d -mindepth 1 -maxdepth 1 | xargs -I% rm -rf %/*
        - save_cache:
            paths:
              - ~/gtk
            key: webkit-v8
#        - run:
#            name: rebuild gtk (temporary)
#            command: source ~/.profile && rm -rf ~/gtk/source/gtk+-2.24.32 && jhbuild buildone --force gtk+
        - run:
            name: Build GIMP and test it
            # build --check does not work as gimp test expects gimp to be installed (BUG)
            # until it is fixed we will run make check after install
            command: | 
              source ~/.profile
              jhbuild build gimp
              cd `jhbuild info gimp|grep '^Sourcedir:'|awk '{print $2}'`
              GTK_PATH=${HOME}/gtk/inst/lib/gtk-2.0/2.10.0 DISPLAY=1 make check
        - run:
            name: Building GIMP help (en) from git
            command: source ~/.profile && ALL_LINGUAS=en jhbuild build gimp-help-git
        - run:
            name: Cleanup
            command: find  ~/gtk/source -type d -mindepth 1 -maxdepth 1 | xargs -I% rm -rf %/*
        - save_cache:
            paths:
              - ~/gtk
            key: gimp-2.10.8-v5
        - run:
            name: Creating DMG package
            command: |
              source ~/.profile
              git clone https://github.com/samm-git/gimp-osx-package
              cd gimp-osx-package
              jhbuild run ./build.sh
        - store_artifacts:
            path: /tmp/artifacts
            destination: builds

workflows:
  version: 2
  build-different-versions:
    jobs:
      - build-gimp-2-10
 
